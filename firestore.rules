rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is admin
    function isAdmin() {
      return request.auth != null && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // Helper function to check if user is doctor
    function isDoctor() {
      return request.auth != null && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'doctor';
    }
    
    // Helper function to check if user is patient
    function isPatient() {
      return request.auth != null && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'patient';
    }
    
    // Users collection - admins can read all, users can read/write their own, doctors can read patients
    match /users/{userId} {
      allow read: if request.auth != null && (request.auth.uid == userId || isAdmin() || isDoctor());
      allow create: if request.auth != null && request.auth.uid == userId;
      allow update: if request.auth != null && (request.auth.uid == userId || isAdmin());
      allow delete: if isAdmin();
    }
    
    // Patients collection - doctors and admins can read, patients can manage their own
    match /patients/{patientId} {
      allow read: if request.auth != null && (request.auth.uid == patientId || isDoctor() || isAdmin());
      allow create: if request.auth != null && request.auth.uid == patientId;
      allow update: if request.auth != null && (request.auth.uid == patientId || isAdmin());
      allow delete: if isAdmin();
    }
    
    // Doctors collection - all authenticated users can read, doctors can update their own, admins can update all
    match /doctors/{doctorId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && request.auth.uid == doctorId;
      allow update: if request.auth != null && (request.auth.uid == doctorId || isAdmin());
      allow delete: if isAdmin();
    }
    
    // Appointments - patients and doctors can read their own, admins can read all
    match /appointments/{appointmentId} {
      allow read: if request.auth != null && 
        (request.auth.uid == resource.data.patientId || 
         request.auth.uid == resource.data.doctorId ||
         isAdmin());
      allow create: if request.auth != null && 
        (request.auth.uid == request.resource.data.patientId || isDoctor());
      allow update: if request.auth != null && 
        (request.auth.uid == resource.data.patientId || 
         request.auth.uid == resource.data.doctorId ||
         isAdmin());
      allow delete: if isAdmin();
    }
    
    // Medical records (subcollection under users) - users can manage their own, doctors with authorization can access
    match /users/{userId}/medical_records/{recordId} {
      allow read: if request.auth != null && 
        (request.auth.uid == userId || 
         (exists(/databases/$(database)/documents/users/$(userId)/medical_records/$(recordId)) &&
          get(/databases/$(database)/documents/users/$(userId)/medical_records/$(recordId)).data.authorizedDoctors.hasAny([request.auth.uid])) ||
         isAdmin());
      allow write: if request.auth != null && 
        (request.auth.uid == userId || isAdmin());
      allow create: if request.auth != null && 
        (request.auth.uid == userId || isAdmin());
      allow delete: if request.auth != null && 
        (request.auth.uid == userId || isAdmin());
    }
    
    // Medical records (top-level collection fallback) - accessible by patient, their doctors, and admins
    match /medical_records/{recordId} {
      allow read: if request.auth != null && 
        (request.auth.uid == resource.data.patientId || 
         resource.data.authorizedDoctors.hasAny([request.auth.uid]) ||
         isAdmin());
      allow write: if request.auth != null && 
        (request.auth.uid == resource.data.patientId || 
         resource.data.authorizedDoctors.hasAny([request.auth.uid]) ||
         isAdmin());
    }
    
    // Prescriptions - accessible by patient, prescribing doctor, and admins
    match /prescriptions/{prescriptionId} {
      allow read: if request.auth != null && 
        (request.auth.uid == resource.data.patientId || 
         request.auth.uid == resource.data.doctorId ||
         isAdmin());
      allow write: if request.auth != null && 
        (request.auth.uid == resource.data.doctorId || isAdmin());
      allow create: if request.auth != null && (isDoctor() || isAdmin());
    }
    
    // Reviews - all authenticated users can read, patients can write their own, admins can manage all
    match /reviews/{reviewId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && 
        (request.auth.uid == resource.data.patientId || isAdmin());
      allow create: if request.auth != null && 
        (request.auth.uid == request.resource.data.patientId || isAdmin());
      allow delete: if isAdmin();
    }
    
    // Doctor verifications - doctors can create their own, admins can read and update all
    match /doctor_verifications/{verificationId} {
      allow read: if request.auth != null && (request.auth.uid == resource.data.doctorId || isAdmin());
      allow create: if request.auth != null && request.auth.uid == request.resource.data.doctorId;
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }
    
    // Chat messages - accessible by participants and admins
    match /chats/{chatId}/messages/{messageId} {
      allow read, write: if request.auth != null && 
        (request.auth.uid in resource.data.participants || isAdmin());
    }
    
    // Family members - users can manage their own, admins can read all
    match /users/{userId}/family_members/{memberId} {
      allow read: if request.auth != null && 
        (request.auth.uid == userId || isAdmin());
      allow write: if request.auth != null && request.auth.uid == userId;
      allow create: if request.auth != null && request.auth.uid == userId;
      allow delete: if request.auth != null && 
        (request.auth.uid == userId || isAdmin());
    }
    
    // Family members (top-level collection fallback)
    match /family_members/{memberId} {
      allow read: if request.auth != null && 
        (request.auth.uid == resource.data.userId || isAdmin());
      allow write: if request.auth != null && request.auth.uid == resource.data.userId;
      allow create: if request.auth != null && request.auth.uid == request.resource.data.userId;
      allow delete: if request.auth != null && 
        (request.auth.uid == resource.data.userId || isAdmin());
    }
    
    // Notifications - users can read/update their own, admins can read all
    match /notifications/{notificationId} {
      allow read: if request.auth != null && 
        (request.auth.uid == resource.data.userId || isAdmin());
      allow update, delete: if request.auth != null && request.auth.uid == resource.data.userId;
      allow create: if true; // Allow system to create notifications
    }
    
    // Time slots - all authenticated users can read, doctors can manage their own
    match /time_slots/{slotId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && 
        (request.auth.uid == resource.data.doctorId || isAdmin());
      allow create: if request.auth != null && 
        (request.auth.uid == request.resource.data.doctorId || isAdmin());
    }
    
    // Doctor schedules - all authenticated users can read, doctors can manage their own
    match /doctor_schedules/{doctorId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && 
        (request.auth.uid == doctorId || isAdmin());
      allow create: if request.auth != null && 
        (request.auth.uid == doctorId || isAdmin());
    }
    
    // Blocked slots - all authenticated users can read, doctors can manage their own
    match /blocked_slots/{slotId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && 
        (request.auth.uid == resource.data.doctorId || isAdmin());
      allow create: if request.auth != null && 
        (request.auth.uid == request.resource.data.doctorId || isAdmin());
    }
    
    // Admin has full access to everything
    match /{document=**} {
      allow read, write: if isAdmin();
    }
  }
}
